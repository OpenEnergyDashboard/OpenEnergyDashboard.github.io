<!doctype html><html class="no-js" lang="en"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1.0"><title>Developer Details</title><link rel="stylesheet" type="text/css" href="https://openenergydashboard.org/assets/css/styles_feeling_responsive.css"> <script src="https://openenergydashboard.org/assets/js/modernizr.min.js"></script> <script src="https://ajax.googleapis.com/ajax/libs/webfont/1.5.18/webfont.js"></script> <script> WebFont.load({ google: { families: [ 'Lato:400,700,400italic:latin', 'Volkhov::latin' ] } }); </script> <noscript><link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic%7CVolkhov' rel='stylesheet' type='text/css'> </noscript><meta name="description" content="Documentation overview Developer documentation Information Overview Starting Developer First Steps Contributor License Agreement Creating Pull Requests Test Data Work Selection Codebase Info Learn OED Technology npm scripts Technology Overview Further Details Code Organization Developer Details Documentation Expectations Environment Variables Full Install Output No npm/DB Install Output Test Code Version Release Releasing OED This information is for developers of the OED software so this information is not usually of interest to a general user. The update to the Redux Toolkit (RTK) is not yet reflected in the documentation. As a result, some information may be out of date. There are many details and good ideas to use as an OED developer. This page tries to give you some of them. The topics covered are: Stopping OED Seeing what is happening with OED Getting a running OED to recognize code changes Accessing the database Rapid testing of a one or a few test(s) Resetting the Postgres database OED environment variables OED Scripts Migrating OED Having multiple versions of OED Rebuild after Docker dependency changes Running without the database container TypeScript Wisdom Database timeout on testing check permission error (historical) Faster OED installation (historical) Stopping OED If you are running in a VSC container, then you can simply click the green icon for the Remote Container and select &quot;Close Remote Container&quot;. You can also shut the container down manually (by right clicking and choosing &quot;stop&quot;) but that is normally only done if something went wrong in shutting down the container in the usual way. If you are running OED outside of Visual Studio Code then go to the terminal where OED is running, you can type ^-c (control and letter c) together to stop OED. Note it is best to only do this once since a second time causes a force stop. An alternative is to use docker compose down in a second terminal that is in the same directory as where the install is happening. This can also be useful if you are having an issue with your docker container(s) since it cleans them all up. Normally, doing ^-z will put the process into the background. This does not work with a running OED. Seeing what is happening with OED Sometimes OED will not act as you expect and you want to know what is going on. There are two normal ways to do this: The &quot;nohup.out&quot; file in the main OED directory shows all the logged messages. (If running OED outside Visual Studio Code then it is in the terminal where you started OED.) It is a good idea to be able to see this while you are running a version you are developing so you can tell when something significant happens. The messages can be informational where these are normal and not an indication of a problem. Any server side console.log output will be here. Any console.log output on the client side will show up in the web browser console. OED has the log file &quot;log.txt&quot; in the main OED directory. All logged messages and errors should be placed in this file. The newest messages are at the end. This file can get large over time so you probably want to focus on lines in the time frame you are interested (they should be timestamped). Using the Redux debugging tools in the web browser is also very valuable. It can also help to look at the traces. To do this you must enable it in the code. Go to src/client/app/index.tsx and do what the comments say to enable traces (comment out one line and uncomment two lines below). Please make sure you do not commit this change/include in a pull request. As the comments indicate, it would be nice to automate this process and maybe a developer will do this work and submit a PR. Getting a running OED to recognize code changes As a developer, you are often changing the code to see what impact it has on a running version of OED. In general, the system should recognize these changes and update the running version. If you change code under the client/ directory, the output will include a rebuild of the code. When that happens, the output will show this line if it worked. This will be in the terminal where OED is running or in nohup.out if you are working inside VSC. oed-web-1 | webpack 5.62.0 compiled successfully in 24100 ms If it fails then you will see one or more failure lines (with failure in red) rather than success. It will also show that it is done rebuilding when you see the line: oed-web-1 | \ [webpack.Progress] 100% It is not safe to reload the new version in the web browser until the rebuild finishes. You must reload to see the new code. If you change code on the server side, you will not see a rebuild but after a few lines of output you will see: oed-web-1 | [INFO@2022-04-24T16:31:17.449Z] Listening on port 3000 and then you can see the changes. Since all these changes are on the server, you do not need to reload the web browser. Normally the output is seen quickly but it can take a little while for webpack to detect the changes. If it ever fails to do this you could shut down OED and restart it but it is generally much easier/faster to go into some file, add a space, remove the space and save the file. This change (that really does nothing) should cause webpack to start the rebuild. In several cases, developers on Windows have reported not having the code rebuild on save. It turned out that the code was not on the WSL/Linux partition (generally under /home). As described in the developer first steps page, it is important to do this properly. Accessing the database There are two ways to access the Postgres database that OED uses. Through the docker container or through pgAdmin To access the database from the docker database container (see info on accessing containers), execute the following command: psql -U oed. You will now be in the Postgres command line for the OED database. It is assumed that you know some SQL and Postgres command line controls if you use this method. One important one is \q which will get you back to the terminal by leaving the Postgres command system. You can also use the pgAdmin utility to access the database. For this method, you need to install pgAdmin on your device. The link to get the latest version is here. Once you have downloaded and installed the correct version for your operating system, you need to enable the port for the connection to pgAdmin. This can be done by going to the docker-compose.yml file in the main OED directory and uncommenting the lines ports: and -&quot;5432&quot;:&quot;5432&quot;. Note you must shut down and restart OED for this to take effect. You should now be able to open pgAdmin and access the database on localhost port 5432 by adding a New Server with these properties: General tab: Name: oed (or whatever desired) Connection tab: Host name/address: localhost Post: 5432 (should be default) Username: oed password: opened (unless changed in docker-compoe.yml) Save password?: enable if desired to log in again without password A screenshot of the setup: When Save, it will verify connection and then open up connection if all is correct. Note that no matter how you access the OED database it is the live system so you can make changes that the running application will see (and damage the information too!). There may be times you want to backup/restore the Postgres data for OED. You can do it by Take a database dump (in the database Docker container terminal) with pg_dump -U oed &amp;gt; dump_$(date +%Y-%m-%d&quot;_&quot;%H_%M_%S.sql) Restore a database dump by first copying the dump into the container with docker cp /path/to/dump.sql container_name:/dump.sql and then restoring it into the database with psql -U oed -f /dump.sql. The /path/to/dump.sql is the file with date &amp; time created in the dump step. TODO Note someone should test/see if you really need to put it into the container first and this has not been tested since we went to working in the database container. Rapid testing of a one or a few test(s) When you make changes to OED or develop new tests, it may be the case that only one or a few tests fail when you run testing (or you want to focus on one test at a time that fails). Running all the tests is much slower than running a single test file. Thus, to run a single test, in the web/vsc docker container (see info on accessing container) do: npm run testsome &amp;lt;first test&amp;gt; [&amp;lt;second test&amp;gt;] where you replace &amp;lt; xxxx test&amp;gt; with the path to the test file you want to run and [ ] indicates this is optional and you can repeat as many times as you want for more tests. For example, to run the web groups test, you would use: npm run testsome src/server/test/web/groups.js and to run the web groups test and the db baselineTests use: npm run testsome src/server/test/web/groups.js src/server/test/db/baselineTests.js If you are using VSC you can easily get the path to any open test file. Right click on the file name in the tab for that editor window and choose &quot;Copy Relative Path&quot;. This can then be pasted into the needed command. Resetting the Postgres database During the initial install of OED, Postgres detects that you have not run before for this install and initializes the database system. It keeps the information in the postgres-data/ directory in the main OED directory. If you or a pull changes the database configuration, it will not automatically be changed on the next OED install. When we change versions of OED we use a migration system to upgrade the database but this may not be available during the development cycle. Given this, it is often easiest to force Postgres to reinitialize the database. Note that doing this will wipe out any data (meter, readings, preferences, etc.) that you have for this instance of OED. If you wish to force Postgres to reinitialize then do the following: Remove the postgres-data/ directory from the main OED directory. While you can move it to keep a copy, some OSes will still use the moved directory as if it exists in the main OED directory (at least until a reboot). Thus, it is probably best to delete the directory. Also note that OED should not be running when you do this as it will cause all kinds of problems when it does not find this directory. OED will automatically recreate the next time you bring it up. To delete this on Linux, you can do rm -rf postgres-data in the main OED directory. Note you may need to be root to remove this directory. If this is the case, use sudo rm -rf postgres-data where you will be prompted for the root password. It is sometimes tricky to know/login as root on a Windows WSL system. In this case, open the PowerShell, and enter the command wsl -u root that will put you in your WSL/Linus terminal as root. You can then directly delete the postgres-data/ directory. You should be very careful using this terminal as you can do damage as the root user. After you delete the postgres-data/ directory on Windows WSL, you will need to delete both OED containers (can do via the Docker Desktop or Docker extension in VSC). Doing a docker compose down in a terminal in the main OED directory will also accomplish this. Otherwise, you are likely to get the following error when you restart OED: Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error mounting &quot;/run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/c5c261024a2161c37bee3afcd0931bd36812e943519b816556c0bfbd60899ef2&quot; to rootfs at &quot;/var/lib/postgresql/data/pgdata&quot;: mount /run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/c5c261024a2161c37bee3afcd0931bd36812e943519b816556c0bfbd60899ef2:/var/lib/postgresql/data/pgdata (via /proc/self/fd/14), flags: 0x5000: no such file or directory: unknown Do an install of OED by reopening it in the VSC container or doing it outside of VSC. Remember if package changes were made then it will reinstall the node_modules. Note the install will take longer do to the extra initializations. Sometimes the first attempt at installation will fail when you do this. Try it one or two times more to see if it will work. (We are trying to determine why this happens.) If not, replace the postgres-data/ directory with the one removed and this should get you running but will not give you a new version of the database. If you have this issue then contact us for help (see link at bottom of page). OED runs in the containerized Docker environment. This means the software and files created are within this container and disappear when you stop running OED (shut the container down). The one exception to this rule is the information stored in the PostgreSQL database. Because this information needs to exist between OED runs to keep the database initialization and OED data, the information is kept within your OED installation in the postgres-data/ directory on your machine&#39;s file system. This is why removing the postgres-data/ directory resets the database within the Docker container. OED environment variables If you want to know about the environment variables that control OED then see the environment page. OED Scripts OED has a number of scripts that are run via commands in the package.json file. A complete listing with descriptions is on the NPM script page. Migrating OED The script src/scripts/updateOED.sh should update all dependencies and migrate the OED database if changes are needed. This may not work (see ideas above) if migrations are not yet available or this has been done before for the same version of OED. Having multiple versions of OED Most developers keep one clone of the OED software. They switch between branches as needed. However, if you are working on multiple versions of OED, esp. where the node modules are changing or the database configuration changes, then you can avoid having to do a full install (see above) by cloning separate copies of OED. When you install it will do the clone you are currently located in (the current directory in your terminal). The database information and all code is kept separate for each installation as part of the Docker containerization. Note you cannot run multiple version of OED simultaneously unless you change the ports it uses (this is not common). Rebuild after Docker dependency changes If a &quot;From&quot; in a Dockerfile is changed, then the version of that software needs to be updated. Docker normally uses its cached version so the update will not happen. To force the update, do: Inside VSC run the command rebuild container. Outside VSC in a terminal do docker compose up --build where you can add other arguments (such as keeping the node modules). This is unusual in that it is done in a terminal on your own machine in the main OED directory and not in an OED Docker container (because you are resetting the Docker containers). This should make Docker use what is specified in the Dockerfile. If there are no changes then it will not download a new version of the needed software but it will be a little slower for the checks and potentially creating the container. OED tries to announce to the Docker channel for developers whenever a change is make to a Dockerfile that would require this action. This is not commonly done. Running without the database container On rare occasions, you may get a database failure during the startup of the database container during the install/startup of OED. (This is not the transient issues noted during the install where the script reports it is continuing). Generally OED will tell you an issue happened in the console output and Docker indicates the database container is not running. In general, the underlying issue should be addressed so you have a correct OED installation. (This happened, for example, during Windows WSL installs until an file permission issue was resolved.) In rare circumstances, you still want to run the OED web container knowing that any operations that touch the database will fail. There is a parameter to the install script that allows this and can be done with: install_args=&quot;--continue_on_db_error&quot; docker compose up or the full install script (not using docker compose up) of docker compose run --service-ports --rm web npm run src/scripts/installOED.sh --continue_on_db_error OED will still try to install the DB, fail and then continue to try to install the web container. You should see the regular messages in the console indicating the web container is running as expected. If you are working inside VSC, you will need to edit the src/scripts/installOED.sh script to add the --continue_on_db_error parameter. TypeScript Wisdom TypeScript is great, but sometimes it requires some rather strange incantations, especially when working with external libraries. We cannot provide information on everything you need to know but here is one of interest: Regarding InjectedIntlProps from react-intl When using react-intl&#39;s higher order component functionality, some incantations are required. When defining a component, it&#39;s necessary to express that the component&#39;s props are actually (your props) ∪ (internationalization injector). This can be done via the &amp;amp; operator, as follows: interfaceSomeProps { prop1: number; } interfaceSomeState { state1: number; } class SomeComponent extends React.Component&amp;lt;SomeProps &amp;amp; InjectedIntlProps, SomeState&amp;gt; { constructor(props: SomeProps: &amp;amp; InjectedIntlProps) { super(props); // ... } // ... } export default injectIntl&amp;lt;SomeProps&amp;gt;(SomeComponent); If the union type is used often, it might be cleaner to create a type alias: type SomePropsWithIntl = SomeProps &amp;amp; InjectedIntlProps; Database timeout on testing Sometimes when you run the OED tests for the first time in a while, you get an error about the database timing out. The message is normally something similar to &quot;Error: Timeout of 15000ms exceeded. For async tests and hooks, ensure &quot;done()&quot; is called; if returning a Promise, ensure it resolves.&quot; If this happens, rerun the test command. It normally works the next time (or within a total or three tries). We are working to change our testing and installation so Postgres is ready before operations continue so this problem will go away. The current fix is to allow a test to take up toe 15,000 ms or 15 seconds to complete so Postgres has time to start up and that is why you see &quot;15000ms&quot; in the error message. We have also set the timeout to be longer in a few tests where the issue was happening. If the problem persists, you can go into package.json and change the 15000 to be a larger value (such as 30000). This means mocha will not terminate a test until 30 seconds have passed. The only known negative of doing this is that a test that will not complete due to an error will take longer for mocha to terminate. However, this is uncommon in OED tests so the change should be fine. check permission error (historical) A few developers have reported that when they run docker compose run --rm web npm run check they get an error similar to &quot;Error: EACCES: permission denied, scandir &#39;/root/.npm/_logs&quot;. We do not believe this will happen any longer now that developers are asked to work within the Docker container. For the historical record the only know fix was to run outside of docker by doing npm run check. It is believed that this issue is due to doing installs as root and then not being root when inside docker but this is not certain. However, at least one developer found that changing the file permissions did not fix the issue. If anyone has this issue or finds a solution then please let us know. Faster OED installation (historical) The installation process was updated in late February 2022 so the node modules are not updated unless needed. This means the node modules will only be updated if the package.json and/or package-lock.json file is update whether by directed edit or from pulling updating versions. As a result, the old method of install_args=&quot;--keep_node_modules&quot; docker compose up should not be needed if you are running current versions of OED software. The keep_node_modules parameter was left for backward compatibility and in the unlikely case where a developer wishes to use it. As expected, the steps and output is different when there is no node module installation as seen in skipping NPM install output."><meta name="google-site-verification" content="Vk0IOJ2jwG_qEoG7fuEXYqv0m2rLa8P778Fi_GrsgEQ"><meta name="msvalidate.01" content="0FB4C028ABCF07C908C54386ABD2D97F" ><link rel="canonical" href="https://openenergydashboard.org/developer/devDetails/"><meta property="og:title" content="Developer Details"><meta property="og:description" content="Documentation overview Developer documentation Information Overview Starting Developer First Steps Contributor License Agreement Creating Pull Requests Test Data Work Selection Codebase Info Learn OED Technology npm scripts Technology Overview Further Details Code Organization Developer Details Documentation Expectations Environment Variables Full Install Output No npm/DB Install Output Test Code Version Release Releasing OED This information is for developers of the OED software so this information is not usually of interest to a general user. The update to the Redux Toolkit (RTK) is not yet reflected in the documentation. As a result, some information may be out of date. There are many details and good ideas to use as an OED developer. This page tries to give you some of them. The topics covered are: Stopping OED Seeing what is happening with OED Getting a running OED to recognize code changes Accessing the database Rapid testing of a one or a few test(s) Resetting the Postgres database OED environment variables OED Scripts Migrating OED Having multiple versions of OED Rebuild after Docker dependency changes Running without the database container TypeScript Wisdom Database timeout on testing check permission error (historical) Faster OED installation (historical) Stopping OED If you are running in a VSC container, then you can simply click the green icon for the Remote Container and select &quot;Close Remote Container&quot;. You can also shut the container down manually (by right clicking and choosing &quot;stop&quot;) but that is normally only done if something went wrong in shutting down the container in the usual way. If you are running OED outside of Visual Studio Code then go to the terminal where OED is running, you can type ^-c (control and letter c) together to stop OED. Note it is best to only do this once since a second time causes a force stop. An alternative is to use docker compose down in a second terminal that is in the same directory as where the install is happening. This can also be useful if you are having an issue with your docker container(s) since it cleans them all up. Normally, doing ^-z will put the process into the background. This does not work with a running OED. Seeing what is happening with OED Sometimes OED will not act as you expect and you want to know what is going on. There are two normal ways to do this: The &quot;nohup.out&quot; file in the main OED directory shows all the logged messages. (If running OED outside Visual Studio Code then it is in the terminal where you started OED.) It is a good idea to be able to see this while you are running a version you are developing so you can tell when something significant happens. The messages can be informational where these are normal and not an indication of a problem. Any server side console.log output will be here. Any console.log output on the client side will show up in the web browser console. OED has the log file &quot;log.txt&quot; in the main OED directory. All logged messages and errors should be placed in this file. The newest messages are at the end. This file can get large over time so you probably want to focus on lines in the time frame you are interested (they should be timestamped). Using the Redux debugging tools in the web browser is also very valuable. It can also help to look at the traces. To do this you must enable it in the code. Go to src/client/app/index.tsx and do what the comments say to enable traces (comment out one line and uncomment two lines below). Please make sure you do not commit this change/include in a pull request. As the comments indicate, it would be nice to automate this process and maybe a developer will do this work and submit a PR. Getting a running OED to recognize code changes As a developer, you are often changing the code to see what impact it has on a running version of OED. In general, the system should recognize these changes and update the running version. If you change code under the client/ directory, the output will include a rebuild of the code. When that happens, the output will show this line if it worked. This will be in the terminal where OED is running or in nohup.out if you are working inside VSC. oed-web-1 | webpack 5.62.0 compiled successfully in 24100 ms If it fails then you will see one or more failure lines (with failure in red) rather than success. It will also show that it is done rebuilding when you see the line: oed-web-1 | \ [webpack.Progress] 100% It is not safe to reload the new version in the web browser until the rebuild finishes. You must reload to see the new code. If you change code on the server side, you will not see a rebuild but after a few lines of output you will see: oed-web-1 | [INFO@2022-04-24T16:31:17.449Z] Listening on port 3000 and then you can see the changes. Since all these changes are on the server, you do not need to reload the web browser. Normally the output is seen quickly but it can take a little while for webpack to detect the changes. If it ever fails to do this you could shut down OED and restart it but it is generally much easier/faster to go into some file, add a space, remove the space and save the file. This change (that really does nothing) should cause webpack to start the rebuild. In several cases, developers on Windows have reported not having the code rebuild on save. It turned out that the code was not on the WSL/Linux partition (generally under /home). As described in the developer first steps page, it is important to do this properly. Accessing the database There are two ways to access the Postgres database that OED uses. Through the docker container or through pgAdmin To access the database from the docker database container (see info on accessing containers), execute the following command: psql -U oed. You will now be in the Postgres command line for the OED database. It is assumed that you know some SQL and Postgres command line controls if you use this method. One important one is \q which will get you back to the terminal by leaving the Postgres command system. You can also use the pgAdmin utility to access the database. For this method, you need to install pgAdmin on your device. The link to get the latest version is here. Once you have downloaded and installed the correct version for your operating system, you need to enable the port for the connection to pgAdmin. This can be done by going to the docker-compose.yml file in the main OED directory and uncommenting the lines ports: and -&quot;5432&quot;:&quot;5432&quot;. Note you must shut down and restart OED for this to take effect. You should now be able to open pgAdmin and access the database on localhost port 5432 by adding a New Server with these properties: General tab: Name: oed (or whatever desired) Connection tab: Host name/address: localhost Post: 5432 (should be default) Username: oed password: opened (unless changed in docker-compoe.yml) Save password?: enable if desired to log in again without password A screenshot of the setup: When Save, it will verify connection and then open up connection if all is correct. Note that no matter how you access the OED database it is the live system so you can make changes that the running application will see (and damage the information too!). There may be times you want to backup/restore the Postgres data for OED. You can do it by Take a database dump (in the database Docker container terminal) with pg_dump -U oed &amp;gt; dump_$(date +%Y-%m-%d&quot;_&quot;%H_%M_%S.sql) Restore a database dump by first copying the dump into the container with docker cp /path/to/dump.sql container_name:/dump.sql and then restoring it into the database with psql -U oed -f /dump.sql. The /path/to/dump.sql is the file with date &amp; time created in the dump step. TODO Note someone should test/see if you really need to put it into the container first and this has not been tested since we went to working in the database container. Rapid testing of a one or a few test(s) When you make changes to OED or develop new tests, it may be the case that only one or a few tests fail when you run testing (or you want to focus on one test at a time that fails). Running all the tests is much slower than running a single test file. Thus, to run a single test, in the web/vsc docker container (see info on accessing container) do: npm run testsome &amp;lt;first test&amp;gt; [&amp;lt;second test&amp;gt;] where you replace &amp;lt; xxxx test&amp;gt; with the path to the test file you want to run and [ ] indicates this is optional and you can repeat as many times as you want for more tests. For example, to run the web groups test, you would use: npm run testsome src/server/test/web/groups.js and to run the web groups test and the db baselineTests use: npm run testsome src/server/test/web/groups.js src/server/test/db/baselineTests.js If you are using VSC you can easily get the path to any open test file. Right click on the file name in the tab for that editor window and choose &quot;Copy Relative Path&quot;. This can then be pasted into the needed command. Resetting the Postgres database During the initial install of OED, Postgres detects that you have not run before for this install and initializes the database system. It keeps the information in the postgres-data/ directory in the main OED directory. If you or a pull changes the database configuration, it will not automatically be changed on the next OED install. When we change versions of OED we use a migration system to upgrade the database but this may not be available during the development cycle. Given this, it is often easiest to force Postgres to reinitialize the database. Note that doing this will wipe out any data (meter, readings, preferences, etc.) that you have for this instance of OED. If you wish to force Postgres to reinitialize then do the following: Remove the postgres-data/ directory from the main OED directory. While you can move it to keep a copy, some OSes will still use the moved directory as if it exists in the main OED directory (at least until a reboot). Thus, it is probably best to delete the directory. Also note that OED should not be running when you do this as it will cause all kinds of problems when it does not find this directory. OED will automatically recreate the next time you bring it up. To delete this on Linux, you can do rm -rf postgres-data in the main OED directory. Note you may need to be root to remove this directory. If this is the case, use sudo rm -rf postgres-data where you will be prompted for the root password. It is sometimes tricky to know/login as root on a Windows WSL system. In this case, open the PowerShell, and enter the command wsl -u root that will put you in your WSL/Linus terminal as root. You can then directly delete the postgres-data/ directory. You should be very careful using this terminal as you can do damage as the root user. After you delete the postgres-data/ directory on Windows WSL, you will need to delete both OED containers (can do via the Docker Desktop or Docker extension in VSC). Doing a docker compose down in a terminal in the main OED directory will also accomplish this. Otherwise, you are likely to get the following error when you restart OED: Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error mounting &quot;/run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/c5c261024a2161c37bee3afcd0931bd36812e943519b816556c0bfbd60899ef2&quot; to rootfs at &quot;/var/lib/postgresql/data/pgdata&quot;: mount /run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/c5c261024a2161c37bee3afcd0931bd36812e943519b816556c0bfbd60899ef2:/var/lib/postgresql/data/pgdata (via /proc/self/fd/14), flags: 0x5000: no such file or directory: unknown Do an install of OED by reopening it in the VSC container or doing it outside of VSC. Remember if package changes were made then it will reinstall the node_modules. Note the install will take longer do to the extra initializations. Sometimes the first attempt at installation will fail when you do this. Try it one or two times more to see if it will work. (We are trying to determine why this happens.) If not, replace the postgres-data/ directory with the one removed and this should get you running but will not give you a new version of the database. If you have this issue then contact us for help (see link at bottom of page). OED runs in the containerized Docker environment. This means the software and files created are within this container and disappear when you stop running OED (shut the container down). The one exception to this rule is the information stored in the PostgreSQL database. Because this information needs to exist between OED runs to keep the database initialization and OED data, the information is kept within your OED installation in the postgres-data/ directory on your machine&#39;s file system. This is why removing the postgres-data/ directory resets the database within the Docker container. OED environment variables If you want to know about the environment variables that control OED then see the environment page. OED Scripts OED has a number of scripts that are run via commands in the package.json file. A complete listing with descriptions is on the NPM script page. Migrating OED The script src/scripts/updateOED.sh should update all dependencies and migrate the OED database if changes are needed. This may not work (see ideas above) if migrations are not yet available or this has been done before for the same version of OED. Having multiple versions of OED Most developers keep one clone of the OED software. They switch between branches as needed. However, if you are working on multiple versions of OED, esp. where the node modules are changing or the database configuration changes, then you can avoid having to do a full install (see above) by cloning separate copies of OED. When you install it will do the clone you are currently located in (the current directory in your terminal). The database information and all code is kept separate for each installation as part of the Docker containerization. Note you cannot run multiple version of OED simultaneously unless you change the ports it uses (this is not common). Rebuild after Docker dependency changes If a &quot;From&quot; in a Dockerfile is changed, then the version of that software needs to be updated. Docker normally uses its cached version so the update will not happen. To force the update, do: Inside VSC run the command rebuild container. Outside VSC in a terminal do docker compose up --build where you can add other arguments (such as keeping the node modules). This is unusual in that it is done in a terminal on your own machine in the main OED directory and not in an OED Docker container (because you are resetting the Docker containers). This should make Docker use what is specified in the Dockerfile. If there are no changes then it will not download a new version of the needed software but it will be a little slower for the checks and potentially creating the container. OED tries to announce to the Docker channel for developers whenever a change is make to a Dockerfile that would require this action. This is not commonly done. Running without the database container On rare occasions, you may get a database failure during the startup of the database container during the install/startup of OED. (This is not the transient issues noted during the install where the script reports it is continuing). Generally OED will tell you an issue happened in the console output and Docker indicates the database container is not running. In general, the underlying issue should be addressed so you have a correct OED installation. (This happened, for example, during Windows WSL installs until an file permission issue was resolved.) In rare circumstances, you still want to run the OED web container knowing that any operations that touch the database will fail. There is a parameter to the install script that allows this and can be done with: install_args=&quot;--continue_on_db_error&quot; docker compose up or the full install script (not using docker compose up) of docker compose run --service-ports --rm web npm run src/scripts/installOED.sh --continue_on_db_error OED will still try to install the DB, fail and then continue to try to install the web container. You should see the regular messages in the console indicating the web container is running as expected. If you are working inside VSC, you will need to edit the src/scripts/installOED.sh script to add the --continue_on_db_error parameter. TypeScript Wisdom TypeScript is great, but sometimes it requires some rather strange incantations, especially when working with external libraries. We cannot provide information on everything you need to know but here is one of interest: Regarding InjectedIntlProps from react-intl When using react-intl&#39;s higher order component functionality, some incantations are required. When defining a component, it&#39;s necessary to express that the component&#39;s props are actually (your props) ∪ (internationalization injector). This can be done via the &amp;amp; operator, as follows: interfaceSomeProps { prop1: number; } interfaceSomeState { state1: number; } class SomeComponent extends React.Component&amp;lt;SomeProps &amp;amp; InjectedIntlProps, SomeState&amp;gt; { constructor(props: SomeProps: &amp;amp; InjectedIntlProps) { super(props); // ... } // ... } export default injectIntl&amp;lt;SomeProps&amp;gt;(SomeComponent); If the union type is used often, it might be cleaner to create a type alias: type SomePropsWithIntl = SomeProps &amp;amp; InjectedIntlProps; Database timeout on testing Sometimes when you run the OED tests for the first time in a while, you get an error about the database timing out. The message is normally something similar to &quot;Error: Timeout of 15000ms exceeded. For async tests and hooks, ensure &quot;done()&quot; is called; if returning a Promise, ensure it resolves.&quot; If this happens, rerun the test command. It normally works the next time (or within a total or three tries). We are working to change our testing and installation so Postgres is ready before operations continue so this problem will go away. The current fix is to allow a test to take up toe 15,000 ms or 15 seconds to complete so Postgres has time to start up and that is why you see &quot;15000ms&quot; in the error message. We have also set the timeout to be longer in a few tests where the issue was happening. If the problem persists, you can go into package.json and change the 15000 to be a larger value (such as 30000). This means mocha will not terminate a test until 30 seconds have passed. The only known negative of doing this is that a test that will not complete due to an error will take longer for mocha to terminate. However, this is uncommon in OED tests so the change should be fine. check permission error (historical) A few developers have reported that when they run docker compose run --rm web npm run check they get an error similar to &quot;Error: EACCES: permission denied, scandir &#39;/root/.npm/_logs&quot;. We do not believe this will happen any longer now that developers are asked to work within the Docker container. For the historical record the only know fix was to run outside of docker by doing npm run check. It is believed that this issue is due to doing installs as root and then not being root when inside docker but this is not certain. However, at least one developer found that changing the file permissions did not fix the issue. If anyone has this issue or finds a solution then please let us know. Faster OED installation (historical) The installation process was updated in late February 2022 so the node modules are not updated unless needed. This means the node modules will only be updated if the package.json and/or package-lock.json file is update whether by directed edit or from pulling updating versions. As a result, the old method of install_args=&quot;--keep_node_modules&quot; docker compose up should not be needed if you are running current versions of OED software. The keep_node_modules parameter was left for backward compatibility and in the unlikely case where a developer wishes to use it. As expected, the steps and output is different when there is no node module installation as seen in skipping NPM install output."><meta property="og:url" content="https://openenergydashboard.org/developer/devDetails/"><meta property="og:locale" content="en_EN"><meta property="og:type" content="website"><meta property="og:site_name" content="Open Energy Dashboard"><link rel="icon" sizes="32x32" href="https://openenergydashboard.org/assets/img/OEDIcon22x32.png"><link rel="icon" sizes="192x192" href="https://openenergydashboard.org/assets/img/OEDIcon192x274.png"><body id="top-of-page" class="page-fullwidth"><div id="navigation" class="sticky"><nav class="top-bar" role="navigation" data-topbar data-options="scrolltop: false"><ul class="title-area"><li class="name"><h1 class="hide-for-large-up"><a href="https://openenergydashboard.org/" class="icon-tree"> Open Energy Dashboard</a></h1><li class="toggle-topbar toggle-topbar-click menu-icon"><a><span>Nav</span></a></ul><section class="top-bar-section"><ul class="left"><li><a href="https://openenergydashboard.org/">home</a><li class="divider"><li class="has-dropdown"> <a href="https://openenergydashboard.org/features/">features</a><ul class="dropdown"><li><a href="https://openenergydashboard.org/features/">features by type</a><li><a href="https://openenergydashboard.org/useAcademic/">features by academic use</a></ul><li class="divider"><li class="has-dropdown"> <a href="https://openenergydashboard.org/helpV1_0_0/user/">Documentation</a><ul class="dropdown"><li><a href="https://openenergydashboard.org/helpV1_0_0/user/">oed version 1.0.0</a><li><a href="https://openenergydashboard.org/helpV0_8_0/user/">oed version 0.8.0</a><li><a href="https://openenergydashboard.org/helpV0_7_0/user/">oed version 0.7.0</a><li><a href="https://openenergydashboard.org/helpV0_6_0/user/">oed version 0.6.0</a></ul><li class="divider"><li><a href="https://openenergydashboard.org/use/">Adopting</a><li class="divider"><li class="has-dropdown"> <a href="https://openenergydashboard.org/news/">info</a><ul class="dropdown"><li><a href="https://openenergydashboard.org/news/">news</a><li><a href="https://openenergydashboard.org/principles/">project principles</a><li><a href="https://openenergydashboard.org/free/">free &amp; maintained</a><li><a href="https://openenergydashboard.org/mission/">mission</a><li><a href="https://openenergydashboard.org/why/">why exists</a><li><a href="https://openenergydashboard.org/projectInfo/">project information pages &amp; license</a><li><a href="https://openenergydashboard.org/name/">why OED name, logo &amp; some history</a></ul><li class="divider"></ul><ul class="right"><li class="divider"><li><a href="https://openenergydashboard.org/search/">Search</a><li class="divider"><li><a href="https://openenergydashboard.org/contact/">Contact</a><li class="divider"><li><a href="https://openenergydashboard.org/developer/developer/">developer docs</a><li class="divider"><li class="has-dropdown"> <a href="https://openenergydashboard.org/involved/">get involved</a><ul class="dropdown"><li><a href="https://openenergydashboard.org/internship/">becoming a developer</a><li><a href="https://openenergydashboard.org/studentExperience/">student experience</a></ul></ul></section></nav></div><div id="masthead-no-image-header"><div class="row"><div class="small-6 small-centered columns"> <a id="logo" title="Open Energy Dashboard – A Free, Open Source Energy/Resource Dashboard"> <img src="https://openenergydashboard.org/assets/img/logoDeveloper.png" alt="Open Energy Dashboard – A Free, Open Source Energy/Resource Dashboard"> </a></div></div></div><nav class="breadcrumbs" role="menubar" aria-label="breadcrumbs"> <a href="https://openenergydashboard.org/">Start</a> <a href="https://openenergydashboard.org/developer/">developer</a> <a class="current">Developer Details</a></nav><div class="row t15"><div class="medium-12 columns"><article><header><p class="subheadline">OED Developer Documentation<h1>Developer Details</h1></header><div class="row"><div class="medium-4 medium-push-8 columns" markdown="1"><div class="panel radius" markdown="1"><div style="list-style: none;" class="side-nav"><h4><a href='../developer/'>Documentation overview</a></h4><div><h5>Developer documentation</h5><div style="padding-left: 1em;"><h6>Information</h6><div style="padding-left: 1em;"> <a href="https://openenergydashboard.org/developer/developer/">Overview</a></br></div></div><div style="padding-left: 1em;"><h6>Starting</h6><div style="padding-left: 1em;"> <a href="https://openenergydashboard.org/developer/gettingStarted/">Developer First Steps</a></br> <a href="https://openenergydashboard.org/developer/cla/">Contributor License Agreement</a></br> <a href="https://openenergydashboard.org/developer/pr/">Creating Pull Requests</a></br> <a href="https://openenergydashboard.org/developer/testData/">Test Data</a></br> <a href="https://openenergydashboard.org/developer/work/">Work Selection</a></br></div></div><div style="padding-left: 1em;"><h6>Codebase Info</h6><div style="padding-left: 1em;"> <a href="https://openenergydashboard.org/developer/learningTechnologies/">Learn OED Technology</a></br> <a href="https://openenergydashboard.org/developer/npm/">npm scripts</a></br> <a href="https://openenergydashboard.org/developer/technologies/">Technology Overview</a></br></div></div><div style="padding-left: 1em;"><h6>Further Details</h6><div style="padding-left: 1em;"> <a href="https://openenergydashboard.org/developer/codeOrganization/">Code Organization</a></br> <a href="https://openenergydashboard.org/developer/devDetails/">Developer Details</a></br> <a href="https://openenergydashboard.org/developer/codeGuidelines/">Documentation Expectations</a></br> <a href="https://openenergydashboard.org/developer/environment/">Environment Variables</a></br> <a href="https://openenergydashboard.org/developer/fullInstallOutput/">Full Install Output</a></br> <a href="https://openenergydashboard.org/developer/noNPMInstallOutput/">No npm/DB Install Output</a></br> <a href="https://openenergydashboard.org/developer/testing/">Test Code</a></br></div></div><div style="padding-left: 1em;"><h6>Version Release</h6><div style="padding-left: 1em;"> <a href="https://openenergydashboard.org/developer/release/">Releasing OED</a></br></div></div></div></div></div></div><div class="medium-8 medium-pull-4 columns" markdown="1"><div class="alert-box info "><p>This information is for developers of the OED software so this information is not usually of interest to a general user.</div><div class="alert-box warning "><p>The update to the Redux Toolkit (RTK) is not yet reflected in the documentation. As a result, some information may be out of date.</div><p>There are many details and good ideas to use as an OED developer. This page tries to give you some of them. The topics covered are:<ol><li><a href="#stopping">Stopping OED</a><li><a href="#goingOn">Seeing what is happening with OED</a><li><a href="#codeChange">Getting a running OED to recognize code changes</a><li><a href="#dbAccess">Accessing the database</a><li><a href="#singleTest">Rapid testing of a one or a few test(s)</a><li><a href="#resetDB">Resetting the Postgres database</a><li><a href="#environment">OED environment variables</a><li><a href="#scripts">OED Scripts</a><li><a href="#migrate">Migrating OED</a><li><a href="#versions">Having multiple versions of OED</a><li><a href="#rebuild">Rebuild after Docker dependency changes</a><li><a href="#noDb">Running without the database container</a><li><a href="#typescript">TypeScript Wisdom</a><li><a href="#testingTimeout">Database timeout on testing</a><li><a href="#npmPermission">check permission error (historical)</a><li><a href="#fastInstall">Faster OED installation (historical)</a></ol><h2 id="stopping">Stopping OED</h2><p>If you are running in a VSC container, then you can simply click the green icon for the Remote Container and select "Close Remote Container". You can also shut the container down manually (by right clicking and choosing "stop") but that is normally only done if something went wrong in shutting down the container in the usual way.<p>If you are running OED outside of Visual Studio Code then go to the terminal where OED is running, you can type ^-c (control and letter c) together to stop OED. Note it is best to only do this once since a second time causes a force stop. An alternative is to use <code>docker compose down</code> in a second terminal that is in the same directory as where the install is happening. This can also be useful if you are having an issue with your docker container(s) since it cleans them all up. Normally, doing ^-z will put the process into the background. This does not work with a running OED.<h2 id="goingOn">Seeing what is happening with OED</h2><p>Sometimes OED will not act as you expect and you want to know what is going on. There are two normal ways to do this:<ul><li>The "nohup.out" file in the main OED directory shows all the logged messages. (If running OED outside Visual Studio Code then it is in the terminal where you started OED.) It is a good idea to be able to see this while you are running a version you are developing so you can tell when something significant happens. The messages can be informational where these are normal and not an indication of a problem. Any server side console.log output will be here.<li>Any console.log output on the client side will show up in the web browser console.<li>OED has the log file "log.txt" in the main OED directory. All logged messages and errors should be placed in this file. The newest messages are at the end. This file can get large over time so you probably want to focus on lines in the time frame you are interested (they should be timestamped).<li>Using the Redux debugging tools in the web browser is also very valuable. It can also help to look at the traces. To do this you must enable it in the code. Go to src/client/app/index.tsx and do what the comments say to enable traces (comment out one line and uncomment two lines below). Please make sure you do not commit this change/include in a pull request. As the comments indicate, it would be nice to automate this process and maybe a developer will do this work and submit a PR.</ul><h2 id="codeChange">Getting a running OED to recognize code changes</h2><p>As a developer, you are often changing the code to see what impact it has on a running version of OED. In general, the system should recognize these changes and update the running version. If you change code under the client/ directory, the output will include a rebuild of the code. When that happens, the output will show this line if it worked. This will be in the terminal where OED is running or in nohup.out if you are working inside VSC.<br> <code>oed-web-1 | webpack 5.62.0 compiled successfully in 24100 ms</code><br> If it fails then you will see one or more failure lines (with failure in red) rather than success. It will also show that it is done rebuilding when you see the line:<br> <code>oed-web-1 | \<s\> [webpack.Progress] 100% </code><br> It is not safe to reload the new version in the web browser until the rebuild finishes. You must reload to see the new code. If you change code on the server side, you will not see a rebuild but after a few lines of output you will see:<br> <code>oed-web-1 | [INFO@2022-04-24T16:31:17.449Z] Listening on port 3000</code><br> and then you can see the changes. Since all these changes are on the server, you do not need to reload the web browser.<p>Normally the output is seen quickly but it can take a little while for webpack to detect the changes. If it ever fails to do this you could shut down OED and restart it but it is generally much easier/faster to go into some file, add a space, remove the space and save the file. This change (that really does nothing) should cause webpack to start the rebuild.<p>In several cases, developers on Windows have reported not having the code rebuild on save. It turned out that the code was not on the WSL/Linux partition (generally under /home). As described in the <a href="../gettingStarted/">developer first steps page</a>, it is important to do this properly.<h2 id="dbAccess">Accessing the database</h2><p>There are two ways to access the Postgres database that OED uses. Through the docker container or through pgAdmin<ul><li> To access the database from the docker database container (see <a href="../gettingStarted/#DockerInfo">info on accessing containers)</a>, execute the following command: <code>psql -U oed</code>. You will now be in the Postgres command line for the OED database. It is assumed that you know some SQL and Postgres command line controls if you use this method. One important one is <code>\q</code> which will get you back to the terminal by leaving the Postgres command system.<li> You can also use the pgAdmin utility to access the database. For this method, you need to install pgAdmin on your device. The link to get the latest version is <a href="https://www.pgadmin.org/download/">here</a>. Once you have downloaded and installed the correct version for your operating system, you need to enable the port for the connection to pgAdmin. This can be done by going to the docker-compose.yml file in the main OED directory and uncommenting the lines <code>ports:</code> and <code>-"5432":"5432"</code>. Note you must shut down and restart OED for this to take effect. You should now be able to open pgAdmin and access the database on localhost port 5432 by adding a New Server with these properties:<ul><li>General tab:<ul><li>Name: oed (or whatever desired)</ul><li>Connection tab:<ul><li>Host name/address: localhost<li>Post: 5432 (should be default)<li>Username: oed<li>password: opened (unless changed in docker-compoe.yml)<li>Save password?: enable if desired to log in again without password</ul></ul><p>A screenshot of the setup:<p><img alt="PGAdmin setup" src="../images/pgAdminSetup.png"><p>When Save, it will verify connection and then open up connection if all is correct.</ul><p>Note that no matter how you access the OED database it is the live system so you can make changes that the running application will see (and damage the information too!).<p>There may be times you want to backup/restore the Postgres data for OED. You can do it by<ul><li>Take a database dump (in the database Docker container terminal) with <code>pg_dump -U oed &gt; dump_$(date +%Y-%m-%d"_"%H_%M_%S.sql)</code><li>Restore a database dump by first copying the dump into the container with <code>docker cp /path/to/dump.sql container_name:/dump.sql</code> and then restoring it into the database with <code>psql -U oed -f /dump.sql</code>. The /path/to/dump.sql is the file with date & time created in the dump step. TODO Note someone should test/see if you really need to put it into the container first and this has not been tested since we went to working in the database container.</ul><h2 id="singleTest">Rapid testing of a one or a few test(s)</h2><p>When you make changes to OED or develop new tests, it may be the case that only one or a few tests fail when you run testing (or you want to focus on one test at a time that fails). Running all the tests is much slower than running a single test file. Thus, to run a single test, in the web/vsc docker container (see <a href="../gettingStarted/#DockerInfo">info on accessing container</a>) do:<br> <code>npm run testsome &lt;first test&gt; [&lt;second test&gt;] </code><br> where you replace &lt; xxxx test&gt; with the path to the test file you want to run and [ ] indicates this is optional and you can repeat as many times as you want for more tests.<p>For example, to run the web groups test, you would use:<br> <code>npm run testsome src/server/test/web/groups.js</code><br> and to run the web groups test and the db baselineTests use:<br> <code>npm run testsome src/server/test/web/groups.js src/server/test/db/baselineTests.js</code><p>If you are using VSC you can easily get the path to any open test file. Right click on the file name in the tab for that editor window and choose "Copy Relative Path". This can then be pasted into the needed command.<h2 id="resetDB">Resetting the Postgres database</h2><p>During the initial install of OED, Postgres detects that you have not run before for this install and initializes the database system. It keeps the information in the postgres-data/ directory in the main OED directory. If you or a pull changes the database configuration, it will not automatically be changed on the next OED install. When we change versions of OED we use a migration system to upgrade the database but this may not be available during the development cycle. Given this, it is often easiest to force Postgres to reinitialize the database. Note that doing this will wipe out any data (meter, readings, preferences, etc.) that you have for this instance of OED. If you wish to force Postgres to reinitialize then do the following:<ol><li>Remove the postgres-data/ directory from the main OED directory. While you can move it to keep a copy, some OSes will still use the moved directory as if it exists in the main OED directory (at least until a reboot). Thus, it is probably best to delete the directory. Also note that OED should not be running when you do this as it will cause all kinds of problems when it does not find this directory. OED will automatically recreate the next time you bring it up.<ul><li>To delete this on Linux, you can do <code>rm -rf postgres-data</code> in the main OED directory. Note you may need to be root to remove this directory. If this is the case, use <code>sudo rm -rf postgres-data</code> where you will be prompted for the root password.<li>It is sometimes tricky to know/login as root on a Windows WSL system. In this case, open the PowerShell, and enter the command <code>wsl -u root</code> that will put you in your WSL/Linus terminal as root. You can then directly delete the postgres-data/ directory. You should be very careful using this terminal as you can do damage as the root user.<li>After you delete the postgres-data/ directory on Windows WSL, you will need to delete both OED containers (can do via the Docker Desktop or Docker extension in VSC). Doing a <code>docker compose down</code> in a terminal in the main OED directory will also accomplish this. Otherwise, you are likely to get the following error when you restart OED:<p> Error response from daemon: failed to create shim task: OCI runtime create failed: runc create failed: unable to start container process: error during container init: error mounting "/run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/c5c261024a2161c37bee3afcd0931bd36812e943519b816556c0bfbd60899ef2" to rootfs at "/var/lib/postgresql/data/pgdata": mount /run/desktop/mnt/host/wsl/docker-desktop-bind-mounts/Ubuntu/c5c261024a2161c37bee3afcd0931bd36812e943519b816556c0bfbd60899ef2:/var/lib/postgresql/data/pgdata (via /proc/self/fd/14), flags: 0x5000: no such file or directory: unknown</ul><li>Do an install of OED by reopening it in the VSC container or doing it outside of VSC. Remember if package changes were made then it will reinstall the node_modules. Note the install will take longer do to the extra initializations.<li>Sometimes the first attempt at installation will fail when you do this. Try it one or two times more to see if it will work. (We are trying to determine why this happens.) If not, replace the postgres-data/ directory with the one removed and this should get you running but will not give you a new version of the database. If you have this issue then contact us for help (see link at bottom of page).</ol><p>OED runs in the containerized Docker environment. This means the software and files created are within this container and disappear when you stop running OED (shut the container down). The one exception to this rule is the information stored in the PostgreSQL database. Because this information needs to exist between OED runs to keep the database initialization and OED data, the information is kept within your OED installation in the postgres-data/ directory on your machine's file system. This is why removing the postgres-data/ directory resets the database within the Docker container.<h2 id="environment">OED environment variables</h2><p>If you want to know about the environment variables that control OED then see the <a href="../environment/">environment page</a>.<h2 id="scripts">OED Scripts</h2><p>OED has a number of scripts that are run via commands in the package.json file. A complete listing with descriptions is on the <a href="../npm/">NPM script</a> page.<h2 id="migrate">Migrating OED</h2><p>The script <code>src/scripts/updateOED.sh</code> should update all dependencies and migrate the OED database if changes are needed. This may not work (see ideas above) if migrations are not yet available or this has been done before for the same version of OED.<h2 id="versions">Having multiple versions of OED</h2><p>Most developers keep one clone of the OED software. They switch between branches as needed. However, if you are working on multiple versions of OED, esp. where the node modules are changing or the database configuration changes, then you can avoid having to do a full install (see above) by cloning separate copies of OED. When you install it will do the clone you are currently located in (the current directory in your terminal). The database information and all code is kept separate for each installation as part of the Docker containerization. Note you cannot run multiple version of OED simultaneously unless you change the ports it uses (this is not common).<h2 id="rebuild">Rebuild after Docker dependency changes</h2><p>If a "From" in a Dockerfile is changed, then the version of that software needs to be updated. Docker normally uses its cached version so the update will not happen. To force the update, do:<ul><li>Inside VSC run the command <code>rebuild container</code>.<li>Outside VSC in a terminal do <code>docker compose up --build</code> where you can add other arguments (such as keeping the node modules). This is unusual in that it is done in a terminal on your own machine in the main OED directory and not in an OED Docker container (because you are resetting the Docker containers).</ul><p>This should make Docker use what is specified in the Dockerfile. If there are no changes then it will not download a new version of the needed software but it will be a little slower for the checks and potentially creating the container. OED tries to announce to the Docker channel for developers whenever a change is make to a Dockerfile that would require this action. This is not commonly done.<h2 id="noDb">Running without the database container</h2><p>On rare occasions, you may get a database failure during the startup of the database container during the install/startup of OED. (This is not the transient issues noted during the install where the script reports it is continuing). Generally OED will tell you an issue happened in the console output and Docker indicates the database container is not running. In general, the underlying issue should be addressed so you have a correct OED installation. (This happened, for example, during Windows WSL installs until an file permission issue was resolved.) In rare circumstances, you still want to run the OED web container knowing that any operations that touch the database will fail. There is a parameter to the install script that allows this and can be done with: <br><code>install_args="--continue_on_db_error" docker compose up</code><br> or the full install script (not using docker compose up) of <br><code>docker compose run --service-ports --rm web npm run src/scripts/installOED.sh --continue_on_db_error</code><br> OED will still try to install the DB, fail and then continue to try to install the web container. You should see the regular messages in the console indicating the web container is running as expected. If you are working inside VSC, you will need to edit the src/scripts/installOED.sh script to add the --continue_on_db_error parameter.<h2 id="typescript">TypeScript Wisdom</h2><p>TypeScript is great, but sometimes it requires some rather strange incantations, especially when working with external libraries. We cannot provide information on everything you need to know but here is one of interest:<h3>Regarding <code>InjectedIntlProps</code> from <code>react-intl</code></h3><p>When using <code>react-intl</code>'s higher order component functionality, some incantations are required. When defining a component, it's necessary to express that the component's props are actually (your props) ∪ (internationalization injector). This can be done via the <code>&amp;</code> operator, as follows:<pre>
interfaceSomeProps {
    prop1: number;
}

interfaceSomeState {
    state1: number;
}

class SomeComponent extends React.Component&lt;SomeProps &amp; InjectedIntlProps, SomeState&gt; {
    constructor(props: SomeProps: &amp; InjectedIntlProps) {
        super(props);
        // ...
    }
    // ...
}

export default injectIntl&lt;SomeProps&gt;(SomeComponent);
	</pre><p>If the union type is used often, it might be cleaner to create a type alias:<pre>
type SomePropsWithIntl = SomeProps &amp; InjectedIntlProps;
	</pre><h2 id="testingTimeout">Database timeout on testing</h2><p>Sometimes when you run the OED tests for the first time in a while, you get an error about the database timing out. The message is normally something similar to "Error: Timeout of 15000ms exceeded. For async tests and hooks, ensure "done()" is called; if returning a Promise, ensure it resolves." If this happens, rerun the test command. It normally works the next time (or within a total or three tries). We are working to change our testing and installation so Postgres is ready before operations continue so this problem will go away. The current fix is to allow a test to take up toe 15,000 ms or 15 seconds to complete so Postgres has time to start up and that is why you see "15000ms" in the error message. We have also set the timeout to be longer in a few tests where the issue was happening. If the problem persists, you can go into package.json and change the 15000 to be a larger value (such as 30000). This means mocha will not terminate a test until 30 seconds have passed. The only known negative of doing this is that a test that will not complete due to an error will take longer for mocha to terminate. However, this is uncommon in OED tests so the change should be fine.<h2 id="npmPermission">check permission error (historical)</h2><p>A few developers have reported that when they run <code>docker compose run --rm web npm run check</code> they get an error similar to "Error: EACCES: permission denied, scandir '/root/.npm/_logs". We do not believe this will happen any longer now that developers are asked to work within the Docker container. For the historical record the only know fix was to run outside of docker by doing <code>npm run check</code>. It is believed that this issue is due to doing installs as root and then not being root when inside docker but this is not certain. However, at least one developer found that changing the file permissions did not fix the issue. If anyone has this issue or finds a solution then please let us know.<h2 id="fastInstall">Faster OED installation (historical)</h2><p>The installation process was updated in late February 2022 so the node modules are not updated unless needed. This means the node modules will only be updated if the package.json and/or package-lock.json file is update whether by directed edit or from pulling updating versions. As a result, the old method of <code>install_args="--keep_node_modules" docker compose up</code> should not be needed if you are running current versions of OED software. The <code>keep_node_modules</code> parameter was left for backward compatibility and in the unlikely case where a developer wishes to use it. As expected, the steps and output is different when there is no node module installation as seen in <a href="../noNPMInstallOutput/">skipping NPM install output</a>.</div></div></article></div></div><div id="up-to-top" class="row"><div class="small-12 columns" style="text-align: right;"> <a class="iconfont" href="#top-of-page">&#xf108;</a></div></div><footer id="footer-content" class="bg-grau"><div id="footer"><div class="row"> <noscript><div class="alert-box warning "><p>Some aspect of this site will not work and others will work better if you enable JavaScript.</div></noscript></div><div class="row"><div class="medium-6 large-5 columns"><h5 class="shadow-black">About This Site</h5><p class="shadow-black"> The OED dashboard allows organization to acquire, archive, analyze and display energy/resource usage. <a href="https://openenergydashboard.org/features/">More ›</a></div><div class="small-6 medium-3 large-3 large-offset-1 columns"><h5 class="shadow-black">Services</h5><ul class="no-bullet shadow-black"><li > <a href="https://openenergydashboard.org/" title=""></a><li > <a href="https://openenergydashboard.org/contact/" title="Contact">Contact</a><li > <a href="https://openenergydashboard.org/sitemap.xml" title="Sitemap for Google Webmaster Tools">sitemap.xml</a></ul></div><div class="small-6 medium-3 large-3 columns"><ul class="no-bullet shadow-black"></ul></div></div></div><div id="subfooter"><nav class="row"><section id="subfooter-left" class="small-12 medium-6 columns credits"><p>Created by the OED team using <a href="http://jekyllrb.com/" target="_blank">Jekyll</a> based on <a href="https://phlow.github.io/feeling-responsive/">Feeling Responsive</a>. This page is part of the Open Energy Dashboard and is subject to the terms of the Mozilla Public License, v. 2.0. If a copy of the MPL was not distributed with this file, you can obtain one at <a href="https://www.mozilla.org/en-US/MPL/2.0/" rel="nofollow">https://www.mozilla.org/en-US/MPL/2.0/</a>.</section><section id="subfooter-right" class="small-12 medium-6 columns"><ul class="inline-list social-icons"><li><a href="https://github.com/OpenEnergyDashboard/OED" target="_blank" class="icon-github" title="Code other repos..."></a></ul></section></nav></div></footer><script src="https://openenergydashboard.org/assets/js/javascript.min.js"></script>
